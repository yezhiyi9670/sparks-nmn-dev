# 基于碰撞箱的精确自动布局

> 这是一个尚未实现或实装的特性设计方案。如果你有问题或者改进建议，可以在 GitHub Issues 或 Discussion 中提出。

尽管许多排版问题都能被 Sparks NMN 自动排版机制解决，需要手动调整的内容还是太多了。此外，一些地方的间距等设置可能也不是那么合理。自动排版机制需要一次深刻的优化，使标记符号、行间距等参数更加智能，这样才能保证用户的注意力聚焦于内容上。

为了保证用户掌握乐谱的空间感，乐谱分行和小节宽度调整仍然手动进行。

## 小修改

### 小节线渲染机制变更

小节线将不再使用音乐字体渲染，而是改用图形。这是为了保证不同高度的乐谱中小节线的外观能保持一致。这还可以保证曲谱行的高度是精确的。

一般声部的曲谱行高度将被缩减（至音符高度的 2.2 倍，音符大小不变），这样可以使乐谱略微紧凑一点，但不会对空间感造成太大影响。

新的属性 `section_height_mult=2.2 (x)` `tab_line_height=0.8 (em)` 将用于控制曲谱行的高度。

### 连音线渲染机制变更

连音线将不再使用三个组件渲染，而是渲染为一条完整的线。线的形态将变为抛物线。

### 小节序号位置变更

小节序号不会再占据每行第一小节的上方空间，而是右对齐于第一小节起始坐标（不扣除边距）处。

## 列空间分配

列空间分配仍然使用之前的机制，但是部分细节有所改动。

### 小节线类型减宽

有的小节线可能很宽，因此小节线占据的宽度应当从小节空间中剔除。

### 拍号减宽

拍号占据的额外宽度根据拍号的实际宽度确定，此外还要加上拍号与小节线的预设间距。

### 占据宽度的新内容

将考虑使插入符号和标记符号占据一定宽度。

## 预渲染组织方案

渲染将不再在一个大的画布上直接进行，而是像装配零件那样。每个零件都将记录自己内部所有碰撞箱的信息。这样，需要测量数据进行布局时，不需要再预先进行模拟。

小的零件可以继续组装成更大的，也可以在中途进行“打包”操作（合并内部所有碰撞箱）。零件最终组装到排版块（Field）级别。

## 碰撞箱

碰撞箱是贴靠坐标轴的矩形框。碰撞箱的合并，就是取能够包裹内部所有碰撞箱的最小碰撞箱。

### 基本图形的碰撞箱

标签：`element`

图形（任意多边形）的碰撞箱取能够包裹所有顶点的最小框。

文本将不再支持指定锚点位置，始终固定为左上角。

- 文本（实测高度型）的碰撞箱取实际测量得到的碰撞箱。
- 文本（固定高度型）的碰撞箱宽度取决于实际测量数据，高度固定为文本实际尺寸与固定系数的乘积。

文本居中等锚点设置改为在放置时通过微调实现。

### 小节碰撞箱

标签：`section`

小节有一个固定碰撞箱，高度由小节线的高度范围决定，宽度为小节的分配宽度（不扣除边距）。

![](./assets/collision-section.png)

小节碰撞箱不考虑其具体内容，空小节也有碰撞箱。

### 小节音符溢出碰撞箱

标签：`note`

对于单个音符（包括其装饰音），如果**打包的碰撞箱**在竖直方向超出小节碰撞箱，则产生小节音符溢出碰撞箱。

![](./assets/collision-note-overflow.png)

注：TAB 拨弦音符没有音符溢出碰撞箱。

### TAB 音符奏法记号碰撞箱

标签：`note`

TAB 音符奏法记号总是标注在最上方线的上面，这将会占据一些空间。这时奏法记号与音符联合组成碰撞箱。

### 连音线溢出碰撞箱

标签：`connector`

连音线图形额外具有自己的碰撞箱，这是因为连音线几乎一定会超出小节高度范围。

![](./assets/collision-connector.png)

### 小节序号、连谱号

标签：`ordinal`

连谱号没有碰撞箱，其效果由小节宽度边界实现。

小节序号的碰撞箱为小节序号文本的实测高度碰撞箱。

![](./assets/collision-ordinal.png)

### 标记符号碰撞箱

标签：`annotation`



### 歌词行

### 歌词替代旋律

## 紧密关联型标记符号行

## 行内布局机制

### 标记符号的调节机制

### 歌词行的调节机制

### 声部间的间距

## 行间距的决定

## 实现要点
